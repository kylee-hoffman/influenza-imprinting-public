---
title: "read NCHS data"
output: html_document
date: "2024-10-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
library(stringi)
library(imprinting)
library(lubridate)
library(janitor)
```

```{r}
source("~/influenza-imprinting/influenza-imprinting-public/code/utils.R")
```

flu as any cause of death
```{r}
flu_deaths_list <- read_nchs_data('/Users/kyhoff/influenza-imprinting/nchs_csv_data',
                                  COD = "flu MCOD",
                                  icd8_codes = c(470:474),
                                  icd9_codes = c(487:488),
                                  icd10_codes = c("J09", paste0("J", 10:11))) # SLOW ~ 15 mins

save(flu_deaths_list, file = "~/influenza-imprinting/data/flu_deaths_list.RData")
```

```{r}
flu_mortality <- do.call(rbind, flu_deaths_list) %>%
  group_by(birth_year, season) %>%
  reframe(flu_deaths = sum(weight))

#rm(flu_deaths_list)
```

Flu as only UCOD
```{r}
flu_ucod_list <- read_nchs_csv_fun('/Users/kyhoff/Desktop/flu imprinting/nchs_csv_data',
                                         COD = "flu UCOD",
                                         icd8_codes = c(470:474),
                                         icd9_codes = c(487:488),
                                         icd10_codes = c("J09", paste0("J", 10:11))) # SLOW

flu_ucod_mortality <- do.call(rbind, flu_ucod_list) %>%
  group_by(birth_year, season) %>%
  reframe(flu_ucod_deaths = sum(weight))

save(flu_ucod_list, file = "~/influenza-imprinting/data/flu_ucod_list.RData")
rm(flu_ucod_list)
```

Pancreatic cancer as UCOD
```{r}
pancreatic_cancer_deaths_list <- read_nchs_csv_fun('/Users/kyhoff/Desktop/flu imprinting/nchs_csv_data',
                                                   COD = "pancreatic cancer",
                                                   icd8_codes = 157,
                                                   icd9_codes = 157,
                                                   icd10_codes = "C25") # SLOW

pancreatic_cancer_mortality <- do.call(rbind, pancreatic_cancer_deaths_list) %>%
  group_by(birth_year, season) %>%
  reframe(pancreatic_cancer_deaths = sum(weight))

save(pancreatic_cancer_deaths_list, 
     file = "~/influenza-imprinting/data/pancreatic_cancer_deaths_list.RData") 
rm(pancreatic_cancer_deaths_list)
```


All cause mortality
```{r}
all_cause_list <- read_nchs_csv_fun('/Users/kyhoff/Desktop/flu imprinting/nchs_csv_data',
                                                   COD = "all cause",
                                                   icd8_codes = NULL,
                                                   icd9_codes = NULL,
                                                   icd10_codes = NULL) # SLOW

all_cause_mortality <- do.call(rbind, all_cause_list) %>%
  group_by(birth_year, season) %>%
  reframe(all_cause_deaths = sum(weight))

#save(all_cause_list, file = "~/influenza-imprinting/data_no_nchs/all_cause_list.RData") 
#rm(all_cause_list)
```

Exposure to make rates from counts
```{r}
exposure_fun <- function() {
  # HMD exposure for mortality rates
  exposure = fread("~/influenza-imprinting/data/Exposures_1x1.txt", skip = 1) %>%
    clean_names(case = "lower_camel") %>% 
    dplyr::select(year, age, total) %>%
    filter(age != "110+" & year %in% 1967:2022) %>%
    mutate(age = as.numeric(age),
           birth_year = year - age) %>%
    filter(birth_year != 1858 & birth_year <= 2020)
  
  monthly_exposure <- exposure %>%
    mutate(date = as.Date(paste0(year, "-01-01"))) %>%
    dplyr::select(-c("age")) %>%
    group_by(birth_year) %>%
    reframe(month = seq(min(date), max(date), by = "month"), 
            year = as.integer(format(month, format = "%Y")),
            across(.cols = total, 
                   .fns = ~ { approx(date, .x, xout = month)$y }))
  
  # season ranges from September to August. Pretty much just shifting exposure levels by 9 months
  # there may be some benefit to uncommenting the code that would split the 2009 flu season differently
  seasonal_exposure <- monthly_exposure %>%
    filter(#case_when(
      #year == 2009 ~ as.numeric(sapply(str_split(month, "-",  n = 3), `[`, 2)) == 5,
      #TRUE ~ as.numeric(sapply(str_split(month, "-",  n = 3), `[`, 2)) == 9)) %>%
      as.numeric(sapply(str_split(month, "-",  n = 3), `[`, 2)) == 9) %>%
    mutate(season = paste0(year, "-", year+1)) %>%
    dplyr::select(season, total, birth_year) %>%
    filter(season != "1967-1968")
  
  return(seasonal_exposure)
}
```

```{r}
seasonal_exposure <- exposure_fun()
```


Combine all data to one df and save
```{r}
mx_data <- seasonal_exposure %>%
  left_join(flu_mortality, by=c("birth_year","season")) %>%
  left_join(flu_ucod_mortality, by=c("birth_year","season")) %>%
  left_join(pancreatic_cancer_mortality, by=c("birth_year","season")) %>%
  left_join(all_cause_mortality, by=c("birth_year","season")) %>% 
  mutate(flu_deaths = replace_na(flu_deaths, 0), # replace NA with 0 for age/year combos without a death
         flu_ucod_deaths = replace_na(flu_ucod_deaths, 0),
         pancreatic_cancer_deaths = replace_na(pancreatic_cancer_deaths, 0),
         flu_mx = flu_deaths / total, # turn the counts into rates
         flu_ucod_mx = flu_ucod_deaths / total,
         cancer_mx = pancreatic_cancer_deaths / total,
         all_cause_mx = all_cause_deaths / total,
         across(everything(), ~ ifelse(is.infinite(.), NA, .)))
```

```{r}
save(mx_data, file = "~/influenza-imprinting/data/01.mortality_data.RData")
#rm(list = ls())
```


