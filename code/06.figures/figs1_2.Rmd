---
title: "fig1"
author: "Kylee Hoffman"
date: "2025-08-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(grid)
library(ggpubr)
library(tidyverse)
library(data.table)
library(scales)
library(cowplot)
```

```{r}
source("~/influenza-imprinting/influenza-imprinting-public/code/utils.R")

load("~/influenza-imprinting/influenza-imprinting-public/data/final_panel_data")
load("~/influenza-imprinting/influenza-imprinting-public/data/lee_carter_parameters.RData")
```




```{r}
A <- ggplot(lee_carter_parameters$ax_bx.df, aes(x = age_recode, y = ax)) +
  geom_ribbon(aes(ymin = ax_lower, ymax = ax_upper), fill = "gray80") +
  geom_line() +
  scale_x_continuous(breaks = c(0, 25, 50, 75, 100)) +
  scale_y_continuous(breaks = c(-15, -12, -9, -6)) +
  labs(x = "", y = bquote(a[x])) +
  theme_bw() +
  theme(text = element_text(size = 16, family = "Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.title.y = element_text(margin = margin(t = 0, r = -5, b = 0, l = -1)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
        plot.margin=margin(l = 1.25, t = 1, b = -0.35, unit = "lines"))
```

```{r}
B <- lee_carter_parameters$kt.df %>% 
  #left_join(data[, c("year_recode", "circulating_strain")], by = "year_recode", multiple = "first") %>% 
  ggplot(aes(x = year_recode, y = kt)) +
  geom_ribbon(aes(ymin = kt_lower, ymax = kt_upper), fill = "gray80") +
  geom_line() +
  #geom_point(aes(color = circulating_strain)) +
  scale_x_continuous(breaks = c(1970, 1980, 1990, 2000, 2010, 2020), 
                     labels = c("1970", "1980", "1990", "2000", "2010", "2020")) +
  labs(x = "", y = bquote(k[t])) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        text = element_text(size = 16, family = "Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.title.y = element_text(margin = margin(t = 0, r = -5, b = 0, l = -1)),
        axis.title.x = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
        plot.margin=margin(l = 1, r = 0.5, b = -0.25, t = 1, unit = "lines"))
```


```{r}
C <- ggplot(lee_carter_parameters$ax_bx.df, aes(x = age_recode, y = bx)) +
  geom_ribbon(aes(ymin = bx_lower, ymax = bx_upper), fill = "gray80") +
  geom_line() +
  scale_x_continuous(breaks = c(0, 25, 50, 75, 100)) +
  scale_y_continuous(n.breaks = 5) +
  theme_bw() +
  theme(text = element_text(size = 16, family = "Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        plot.margin=margin(r = 0.1, t = -0.3, b = 0.1, l = 0.25, unit = "lines"),
        panel.background = element_blank(),
        axis.title.y = element_text(margin = margin(t = 0, r = -5, b = 0, l = -1)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = -0.5, l = 0))) +
  labs(x = "Age", y = bquote(b[x]))
```

```{r}
D <- data %>% 
  group_by(year_recode) %>% 
  reframe(deaths_fitted = sum(flu_deaths_fitted, na.rm = TRUE),
            deaths_obs = sum(flu_deaths, na.rm = TRUE),
            exposure = sum(total, na.rm = TRUE)) %>% 
  mutate(total_flu_mx = deaths_obs / exposure * 100000,
         total_flu_mx_fitted = deaths_fitted / exposure * 100000) %>% 
  ggplot() +
  geom_point(aes(x = year_recode, y = total_flu_mx_fitted, color = "Fitted"), 
             alpha = 1, size = 3.25, shape = 17) +
  geom_point(aes(x = year_recode, y = total_flu_mx, color = "Observed"), alpha = 1, size = 1.5) +
  scale_color_manual(name = NULL, values = c("Observed" = "#4f4f4f", "Fitted" = "#09d1db")) +
  labs(color = "", x = "Season", y = "Influenza deaths per 100,000") +
  scale_y_continuous(limits = c(0, 5.15), breaks = seq(0, 5, by = 1)) +
  theme_bw() +
  theme(legend.position = c(0.68, 0.98), legend.justification = c(0, 1), 
        legend.background = element_rect(color = "black", fill = "white", linewidth = 0.25),
        legend.text = element_text(size = 12), legend.key.size = unit(0.3, "cm"),
        text = element_text(size = 16, family = "Helvetica"),
        axis.text.x = element_text(angle = 60, hjust = 1, margin = margin(t = -0.5)),
        axis.title.y = element_text(margin = margin(t = 0, r = 4, b = 0, l = 0)),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(),
        plot.margin=margin(l = 2, r = 0.375, t = -0.3, b = 0.1, unit = "lines"))
```

```{r}
fig1 <- ggarrange(ggarrange(A, B,
                    ncol = 2,
                    labels = c("A", "B"),
                    font.label = list(size = 18, color = "black", family = "Helvetica"),
                    label.x = 0.05),
        ggarrange(C, D,
                  ncol = 2,
                  labels = c("C", "D"),
                  font.label = list(size = 18, color = "black", family = "Helvetica"),
                  label.y = 1.125, label.x = 0.05),
                  ncol = 1, nrow = 2,
                 font.label = list(size = 18, color = "black", family = "Helvetica"))

ggsave(filename = "~/influenza-imprinting/plots/final_figs/fig1_style2.png", 
       plot = fig1, height = 7, width = 9, dpi = 800, bg='#ffffff')
```







```{r}
A2 <- data %>% 
  filter(season != "2020-2021", !(imprinted_strain %in% c("naive", "mixed", "H1N1pdm09"))) %>%
  mutate(new_imprinted_strain = case_when(imprinted_strain %in% c("pH1N1", "H1N1_alpha") ~ "pH1N1_H1N1_alpha",
                                          imprinted_strain %in% c("H1N1_beta", "H1N1_gamma") ~ "H1N1_beta_gamma",
                                          TRUE ~ as.character(imprinted_strain))) %>%
  group_by(new_imprinted_strain, age_recode) %>% 
  summarize(mean_rate = mean(flu_mx) * 100000,
            mean_sd = sd(flu_mx) * 100000,
            n = n()) %>%
  mutate(upper = mean_rate + mean_sd/sqrt(n), lower = mean_rate - mean_sd/sqrt(n)) %>%
  ungroup() %>% 
  mutate(new_imprinted_strain = factor(new_imprinted_strain, 
                                       levels = c("unknown", "pH1N1_H1N1_alpha", "H1N1_beta_gamma", 
                                                  "H2N2", "H3N2", "mixed"))) %>% 
  ggplot(aes(x = as.numeric(age_recode), y = mean_rate, fill = new_imprinted_strain,
             color = new_imprinted_strain)) + geom_point(alpha = 0.8, shape = 1) +
  geom_errorbar(aes(ymin=(lower), ymax=(upper), group = new_imprinted_strain,
                    color = new_imprinted_strain), alpha = 0.6, width = 0.2)  +
  geom_smooth(method = "loess", linewidth = 0.8) +
  scale_y_continuous(trans = "log10", breaks = c(0.01, 0.10, 1.00, 10.0, 100), 
                     labels = c("0.01", "0.10", "1.00", "10.0", "100")) +
  scale_color_manual(name = "Imprinted strain  ", 
                     values = c(mixed = "#989898",
                                unknown = "#555",
                                pH1N1_H1N1_alpha = "#ff6698",
                                H1N1_beta_gamma = "#ff8900",
                                H2N2 = "#95C90F", 
                                H3N2 = "#3683C3"),
                     labels = c(mixed = "Mixed",
                                unknown = "Unknown",
                                pH1N1_H1N1_alpha = bquote(pH1N1["\u03b1"]/H1N1["\u03b1"]),
                                H1N1_beta_gamma = bquote(H1N1["\u03b2"]/H1N1["\u03b3"]))) +
  scale_fill_manual(values = c(mixed = "#989898",
                               unknown = "#555",
                               pH1N1_H1N1_alpha = "#F68DBB",
                               H1N1_beta_gamma = "#FAA948",
                               H2N2 = "#ced07d", 
                               H3N2 = "#b4c9fe"),
                    guide = "none") +
  scale_x_continuous(n.breaks = 8) +
  labs(color = "", fill = "", x = "Age", y = "Mean influenza mortality rate") +
  theme_bw() +
  theme(legend.justification = c(0, 1), legend.position = c(.0115, 0.98),
        legend.background = element_rect(color = "black", fill = "white", linewidth = 0.25),
        legend.title = element_text(size = 14),
        legend.key.size = unit(0.55, "cm"),
        text = element_text(size = 15, family = "Helvetica"),
        plot.margin=margin(r = 0.75, l = 0.25, b = 0.3, unit = "lines"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank()) + 
  guides(color = guide_legend(override.aes = list(fill=NA)))
```
mean cohort mortality by year
```{r}
B2 <- data %>% 
  filter(season != "2020-2021", !(imprinted_strain %in% c("naive", "H1N1pdm09", "mixed"))) %>%
  mutate(new_imprinted_strain = case_when(imprinted_strain %in% c("pH1N1", "H1N1_alpha") ~ "pH1N1_H1N1_alpha",
                                          imprinted_strain %in% c("H1N1_beta", "H1N1_gamma") ~ "H1N1_beta_gamma",
                                          TRUE ~ as.character(imprinted_strain))) %>%
  group_by(new_imprinted_strain, year_recode) %>% 
  summarize(mean_death_rate = mean(flu_mx) * 100000,
            sd_death_rate = sd(flu_mx) * 100000,
            n = n()) %>%
  mutate(upper = mean_death_rate + sd_death_rate/sqrt(n), lower = mean_death_rate - sd_death_rate/sqrt(n)) %>% 
  ungroup() %>% 
  mutate(new_imprinted_strain = factor(new_imprinted_strain, 
                                       levels = c("unknown", "pH1N1_H1N1_alpha", "H1N1_beta_gamma", "H2N2", "H3N2", "mixed"))) %>% 
  ggplot(aes(x = as.numeric(year_recode), y = mean_death_rate, fill = new_imprinted_strain,
             color = new_imprinted_strain)) + geom_point(alpha = 0.8, shape = 1) +
  geom_errorbar(aes(ymin=(lower), ymax=(upper), group = new_imprinted_strain,
                    color = new_imprinted_strain), alpha = 0.8, width = 0.2)  +
  geom_smooth(method = "loess", linewidth = 0.6, alpha = 0.5) +
  scale_y_continuous(trans = "log10", breaks = c(0.01, 0.10, 1.00, 10.0, 100), labels = c("0.01", "0.10", "1.00", "10.0", "100")) +
  scale_color_manual(name = "Imprinted strain  ", 
                     values = c(mixed = "#989898",
                                unknown = "#555",
                                pH1N1_H1N1_alpha = "#ff6698",
                                H1N1_beta_gamma = "#ff8900",
                                H2N2 = "#95C90F", 
                                H3N2 = "#3683C3"),
                     labels = c("mixed" = "Mixed",
                                "unknown" = "Unknown",
                                pH1N1_H1N1_alpha = bquote(pH1N1["\u03b1"]/H1N1["\u03b1"]),
                                H1N1_beta_gamma = bquote(H1N1["\u03b2"]/H1N1["\u03b3"]))) +
  scale_fill_manual(values = c(mixed = "#989898",
                               unknown = "#555",
                               pH1N1_H1N1_alpha = "#F68DBB",
                               H1N1_beta_gamma = "#FAA948",
                               H2N2 = "#ced07d", 
                               H3N2 = "#b4c9fe"),
                    guide = "none") +
  labs(color = "", fill = "", x = "Influenza season", y = "Mean influenza mortality rate") +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size = 15, family = "Helvetica"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin=margin(r = 0.75, l = 0.25, t = 0.3, unit = "lines")) + 
  coord_cartesian(xlim = c(1969, 2018))
```

```{r}
fig2 <- ggarrange(NULL, A2, B2,
          ncol = 1, nrow = 3, heights = c(0.05, 1, 1),
          labels = c("", "A", "B"), label.y = 1.06, label.x = 0.0275,
          font.label = list(size = 18, color = "black", family = "Helvetica"))
```

```{r}
ggsave(filename = "~/influenza-imprinting/plots/final_figs/fig2_style2.png", 
       plot = fig2, height = 7, width = 7, dpi = 800, bg='#ffffff')
```


